// -------- 設定 --------
// ★ここにスプレッドシートIDを入れてください
const SPREADSHEET_ID = "18ppSXkGFKw1xAS7vptDGhLvOQ7AUoIWOcXhQfbvlb_c";

// ★ここをCSVのシート名と完全に一致させました
const ALLOWED_SHEETS = ["ポケモン", "ワンピース", "遊戯王", "ヴァイスシュバルツ","素体"]; 

const HEADERS = ["id", "name", "type", "series", "grade", "price", "remaining", "active", "imageUrl"];

// -------- 初期化（シート作成用）--------
function initAllSheets() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  ALLOWED_SHEETS.forEach(sheetName => {
    let sh = ss.getSheetByName(sheetName);
    if (!sh) {
      sh = ss.insertSheet(sheetName);
      sh.getRange(1, 1, 1, HEADERS.length).setValues([HEADERS]);
      sh.setFrozenRows(1);
    }
  });
}

// -------- Web API --------
function doGet(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    
    // パラメータ取得（デフォルトはリストの最初）
    let category = (e?.parameter?.category || ALLOWED_SHEETS[0]);

    if (!ALLOWED_SHEETS.includes(category)) {
      return json_({ error: "無効なカテゴリです", allowed: ALLOWED_SHEETS });
    }

    const sh = ss.getSheetByName(category);
    if (!sh) {
      return json_({ error: `シート「${category}」が見つかりません。` });
    }

    const values = sh.getDataRange().getValues();
    if (!values || values.length < 2) {
      return json_({ category, count: 0, items: [] });
    }

    const headers = values.shift().map(h => String(h).trim());
    let rows = values
      .filter(r => r.some(v => v !== "" && v !== null))
      .map(r => Object.fromEntries(headers.map((h, i) => [h, r[i]])));

    // フィルタ処理
    const q = (e?.parameter?.q || "").toLowerCase();
    const type = e?.parameter?.type || "";
    const sort = e?.parameter?.sort || "";
    const hideZero = e?.parameter?.hideZero === "1";

    if (q) {
      rows = rows.filter(x => 
        String(x.name || "").toLowerCase().includes(q) || 
        String(x.series || "").toLowerCase().includes(q)
      );
    }
    
    // activeがTRUEのものだけ表示
    rows = rows.filter(x => String(x.active).toUpperCase() === "TRUE");
    
    if (type) rows = rows.filter(x => String(x.type) === type);
    if (hideZero) rows = rows.filter(x => Number(x.remaining) > 0);

    // ★★★ データ整形 ★★★
    rows = rows.map(x => {
      const price = x.price ? Number(String(x.price).replace(/,/g, "")) : 0; // カンマ除去対応
      const remaining = x.remaining ? Number(x.remaining) : 0;
      
      // グレード表示ロジック:
      // 「type」が「シングル」の場合のみグレードを表示
      let grade = x.grade;
      if (String(x.type) !== "シングル") {
        grade = ""; 
      }

      return { ...x, price, remaining, grade };
    });

    if (sort === "price_desc") rows.sort((a,b) => b.price - a.price);
    if (sort === "price_asc")  rows.sort((a,b) => a.price - b.price);

    return json_({ category, count: rows.length, items: rows });

  } catch (err) {
    return json_({ error: "サーバーエラー", message: String(err) });
  }
}

function json_(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}

